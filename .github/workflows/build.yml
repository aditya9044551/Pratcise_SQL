name: Build & Deploy SQL DACPAC

on:
  push:
    branches:
      - main

jobs:

  build:
    name: Build DACPAC
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet Packages
        run: |
          msbuild "Pratcise_SQL/Pratcise_SQL.sqlproj" `
            /t:Restore `
            /p:Configuration=Release

      - name: Build SQL Project
        run: |
          msbuild "Pratcise_SQL/Pratcise_SQL.sqlproj" `
            /p:Configuration=Release `
            /p:Platform="Any CPU"

      - name: Upload DACPAC Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dacpac
          path: "Pratcise_SQL/bin/Any CPU/Release/Pratcise_SQL.dacpac"


  report:
    name: Generate Deployment Report
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download DACPAC Artifact
        uses: actions/download-artifact@v4
        with:
          name: dacpac
          path: ./dacpac

      - name: Install SqlPackage
        run: |
          dotnet tool update -g microsoft.sqlpackage
          $toolsPath = "$env:USERPROFILE\.dotnet\tools"
          echo $toolsPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH += ";$toolsPath"

      - name: Generate Deployment Report
        run: |
          & "$env:USERPROFILE\.dotnet\tools\sqlpackage.exe" /Action:DeployReport `
            /SourceFile:"./dacpac/Pratcise_SQL.dacpac" `
            /TargetServerName:"${{ secrets.SQL_SERVER }}" `
            /TargetDatabaseName:"${{ secrets.SQL_DATABASE }}" `
            /TargetUser:"${{ secrets.SQL_USERNAME }}" `
            /TargetPassword:"${{ secrets.SQL_PASSWORD }}" `
            /TargetTrustServerCertificate:True `
            /OutputPath:"./deployment-report.xml"

      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: ./deployment-report.xml

      - name: Show Report in GitHub Summary
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Deployment Report"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```xml'
          Get-Content ./deployment-report.xml | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'

  deploy:
    name: Deploy DACPAC to SQL Server
    runs-on: self-hosted
    needs: report
    environment: production

    steps:
      - name: Download DACPAC Artifact
        uses: actions/download-artifact@v4
        with:
          name: dacpac
          path: ./dacpac

      - name: Install SqlPackage
        run: |
          dotnet tool update -g microsoft.sqlpackage
          $toolsPath = "$env:USERPROFILE\.dotnet\tools"
          echo $toolsPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH += ";$toolsPath"

      - name: Deploy DACPAC to SQL Server
        run: |
          & "$env:USERPROFILE\.dotnet\tools\sqlpackage.exe" /Action:Publish `
            /SourceFile:"./dacpac/Pratcise_SQL.dacpac" `
            /TargetServerName:"${{ secrets.SQL_SERVER }}" `
            /TargetDatabaseName:"${{ secrets.SQL_DATABASE }}" `
            /TargetUser:"${{ secrets.SQL_USERNAME }}" `
            /TargetPassword:"${{ secrets.SQL_PASSWORD }}" `
            /TargetTrustServerCertificate:True `
            /p:BlockOnPossibleDataLoss=true

      - name: Notify Success
        if: success()
        run: echo "✅ DACPAC deployed successfully"

      - name: Notify Failure
        if: failure()
        run: echo "❌ Deployment failed! Check logs above."