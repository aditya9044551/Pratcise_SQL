name: Build & Deploy SQL DACPAC

on:
  push:
    branches:
      - main

jobs:
 
  build:
    name: Build DACPAC
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet Packages
        run: |
          msbuild "Pratcise_SQL/Pratcise_SQL.sqlproj" `
            /t:Restore `
            /p:Configuration=Release

      - name: Build SQL Project
        run: |
          msbuild "Pratcise_SQL/Pratcise_SQL.sqlproj" `
            /p:Configuration=Release `
            /p:Platform="Any CPU"

      - name: Upload DACPAC Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dacpac
          path: Pratcise_SQL/bin/Any CPU/Release/Pratcise_SQL.dacpac

  report:
    name: Generate Deployment Report
    runs-on: windows-latest
    needs: build                   

    steps:
      - name: Download DACPAC Artifact
        uses: actions/download-artifact@v4
        with:
          name: dacpac
          path: ./dacpac

      - name: Install SqlPackage
        run: dotnet tool install -g microsoft.sqlpackage

      - name: Generate Deployment Report
        run: |
          sqlpackage /Action:DeployReport `
            /SourceFile:"./dacpac/Pratcise_SQL.dacpac" `
            /TargetServerName:"${{ secrets.SQL_SERVER }}" `
            /TargetDatabaseName:"${{ secrets.SQL_DATABASE }}" `
            /TargetUser:"${{ secrets.SQL_USERNAME }}" `
            /TargetPassword:"${{ secrets.SQL_PASSWORD }}" `
            /OutputPath:"./deployment-report.xml"

      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: ./deployment-report.xml

        
    name: Deploy DACPAC to SQL Server
    runs-on: windows-latest
    needs: report                     # waits for report to finish
    environment: production           # üîí requires manual approval in GitHub

  
   steps:
      - name: Download DACPAC Artifact
        uses: actions/download-artifact@v4
        with:
          name: dacpac
          path: ./dacpac

      - name: Install SqlPackage
        run: dotnet tool install -g microsoft.sqlpackage

      - name: Deploy DACPAC to SQL Server
        run: |
          sqlpackage /Action:Publish `
            /SourceFile:"./dacpac/Pratcise_SQL.dacpac" `
            /TargetServerName:"${{ secrets.SQL_SERVER }}" `
            /TargetDatabaseName:"${{ secrets.SQL_DATABASE }}" `
            /TargetUser:"${{ secrets.SQL_USERNAME }}" `
            /TargetPassword:"${{ secrets.SQL_PASSWORD }}" `
            /p:BlockOnPossibleDataLoss=true

      - name: Notify Success
        if: success()
        run: echo "‚úÖ DACPAC deployed successfully to ${{ secrets.SQL_DATABASE }}"

      - name: Notify Failure
        if: failure()
        run: echo "‚ùå Deployment failed! Check logs above."